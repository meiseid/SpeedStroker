#include "mondai.h"#include "sst.h"#include "appdata.h"#include "char.h"static DWORD g_dwMissMondaiOK;static DWORD g_dwNumOfMondai;static DWORD g_dwTypeTotal;static DWORD g_dwTypeMissTotal;static DWORD g_dwClearMondai;static DWORD g_dwMissMondai;static DWORD g_dwStartTime;static DWORD g_dwEndTime;static CHAR g_Label[256];static CHAR g_Type[256];static CHAR g_TypeLow[256];static DWORD g_TypeIndex;static DWORD g_TypeMiss;static DWORD g_TypeMissOK;static DWORD g_TimeOverOK;static UINT g_uStatus;static BOOL g_bGameClear;static DWORD g_dwScore;static INT g_iRank;//現在の問題データファイルstatic INT g_iSST = -1;//データ増えんのやだなぁ(T_T)static CHAR g_strSummany[8][64];//成績の計算static VOID CalcSummany( VOID );static VOID RemakeString( LPSTR lpszIO,INT iNum );VOID SetSSTId( INT iSSTId ){	g_iSST = iSSTId;}VOID InitializeMondaiData( VOID ){	g_dwNumOfMondai = InitializeSSTA( GetSSTA(),g_iSST,GetGameOption()->dwNoruma );	switch( GetGameOption()->wDifficulty ){		case 1:			 g_dwMissMondaiOK = g_dwNumOfMondai; //無制限		break;				case 2:			g_dwMissMondaiOK = g_dwNumOfMondai/3*2; // 2/3間違えてよい		break;				case 3:			g_dwMissMondaiOK = g_dwNumOfMondai/3; // 1/3間違えてよい		break;				case 4:			g_dwMissMondaiOK = g_dwNumOfMondai/5; // 1/5間違えてよい(デフォルト)		break;				case 5:			g_dwMissMondaiOK = g_dwNumOfMondai/10; // 1/10間違えてよい		break;				case 6:			g_dwMissMondaiOK = g_dwNumOfMondai/15; // 1/15間違えてよい		break;				case 7:			g_dwMissMondaiOK = g_dwNumOfMondai/20; // 1/20間違えてよい			if( g_dwNumOfMondai >= 200 )				g_dwMissMondaiOK = 10; //10問以上のミスは許さない		break;				case 8:			g_dwMissMondaiOK = g_dwNumOfMondai/20; // 1/20間違えてよい			if( g_dwNumOfMondai >= 100 )				g_dwMissMondaiOK = 5; //5問以上のミスは許さない		break;				default:			g_dwMissMondaiOK = g_dwNumOfMondai/5; // 1/5間違えてよい(デフォルト)		break;	}	g_dwTypeMissTotal = 0;    g_dwMissMondai = 0;    g_dwTypeTotal = 0;    g_dwClearMondai = 0;        g_bGameClear = FALSE;    g_dwScore = 0;    g_iRank = 0;    	NextMondai();		}VOID StartMondaiData( VOID ){	g_dwStartTime = GetTickCount();}VOID EndMondaiData( VOID ){	g_dwEndTime = GetTickCount();	CalcSummany();}UINT NextMondai( VOID ){	if( !GetNextElementA( GetSSTA(),g_Label,g_Type,g_TypeLow ) )		return MM_MONDAIDATAEND;		   g_TypeIndex = 0;   g_TypeMiss = 0;		switch( GetGameOption()->wDifficulty ){		case 1:			 g_TypeMissOK = lstrlen(g_Type);	//無制限   			g_TimeOverOK = (lstrlen(g_Type)*3)*1000;		//1文字につき3秒		break;				case 2:			 g_TypeMissOK = lstrlen(g_Type)/3*2;	//2/3間違えてよい   			g_TimeOverOK = (lstrlen(g_Type)*2)*1000;		//1文字につき2秒		break;				case 3:			 g_TypeMissOK = lstrlen(g_Type)/3;		//1/3間違えてよい   			g_TimeOverOK = lstrlen(g_Type)*1000;		//1文字につき1秒		break;				case 4:			 g_TypeMissOK = lstrlen(g_Type)/5;		//1/5間違えてよい   			g_TimeOverOK = (lstrlen(g_Type)/2)*1000;		//2文字につき1秒		break;				case 5:			 g_TypeMissOK = lstrlen(g_Type)/7;		//1/7間違えてよい   			g_TimeOverOK = (lstrlen(g_Type)/3)*1000;		//3文字につき1秒		break;				case 6:			 g_TypeMissOK = lstrlen(g_Type)/10;		//1/10間違えてよい   			g_TimeOverOK = (lstrlen(g_Type)/4)*1000;		//4文字につき1秒		break;				case 7:			 g_TypeMissOK = lstrlen(g_Type)/15;		//1/15間違えてよい   			g_TimeOverOK = (lstrlen(g_Type)/5)*1000;		//5文字につき1秒		break;				case 8:			g_TypeMissOK = 0;		//1文字のミスも許さない   			g_TimeOverOK = (lstrlen(g_Type)/6)*1000;		//6文字につき1秒		break;				default:		 	g_TypeMissOK = lstrlen(g_Type)/5;		//1/5間違えてよい   			g_TimeOverOK = (lstrlen(g_Type)/2)*1000;		//2文字につき1秒		break;	}    //最低1秒与える	if( g_TimeOverOK == 0 )		g_TimeOverOK = 1000;   return MM_MONDAIENABLE;}UINT TimeOverMondai( VOID ){	PlayAppSound( PAS_TIMEOVER );		g_uStatus = STATUS_TIMEOVER;	//ゲームオーバー	if( ++g_dwMissMondai>g_dwMissMondaiOK ){        		return MM_MONDAIDATAEND;        	}    	return NextMondai();}VOID GiveUpMondai( VOID ){	PlayAppSound( PAS_GIVEUP );	g_uStatus = STATUS_GIVEUP;}LONG GetMondaiValiable( UINT uValiableID ){	LONG ret = 0;		//Just a dummy	switch( uValiableID ){	case GMV_TIMEOVEROK:		ret = g_TimeOverOK;	break;		case GMV_GAMECLEAR:		ret = (LONG)g_bGameClear;	break;			case GMV_STATUS:		ret = (LONG)g_uStatus;	break;		case GMV_SCORE:		ret = (LONG)g_dwScore;	break;		case GMV_RANK:		ret = (LONG)g_iRank;	break;		}		return ret;	}//code 入力文字//status 問題データ状況//RET:TRUE>成功ストローク FALSE>失敗ストロークBOOL ModifyMondai( BYTE code,UINT *status ){	BOOL ret;	BYTE byCodeNew=code;	DWORD dwInc=0;	DWORD dwPreInc =0;		*status = MM_MONDAIENABLE;//	if( !ConvertChar( code,g_TypeIndex,g_Type,&byCodeNew,&dwInc ) )	if( !ConvertChar( code,g_TypeIndex,g_TypeLow,&byCodeNew,&dwInc,&dwPreInc ) )		return FALSE;			if( dwPreInc ){		g_TypeIndex+=dwPreInc;		if( !ConvertChar( code,g_TypeIndex,g_TypeLow,&byCodeNew,&dwInc,&dwPreInc ) )		return FALSE;	}		g_dwTypeTotal++;    //タイプ正解?    if( byCodeNew == g_Type[g_TypeIndex] || byCodeNew == g_TypeLow[g_TypeIndex] ){  	PlayAppSound( PAS_OK );     		ret = TRUE;        //問題終了 ?        if( g_Type[++g_TypeIndex]=='\0' ){        	PlayAppSound( PAS_GOOD );        	g_dwClearMondai++;   			*status = MM_MONDAIEND;   			g_uStatus = STATUS_GOOD;            //ゲーム終了?        	if( NextMondai() == MM_MONDAIDATAEND ){            	*status = MM_MONDAIDATAEND;            	g_bGameClear = TRUE; //ゲームクリアー            }        }    }    else{    	PlayAppSound( PAS_NG );    	ret = FALSE;    	g_dwTypeMissTotal++;        //問題終了?        if( ++g_TypeMiss>g_TypeMissOK ){        	PlayAppSound( PAS_MISS );        	*status = MM_MONDAIEND;        	g_uStatus = STATUS_MISS;        	//ゲーム終了?        	if( ++g_dwMissMondai>g_dwMissMondaiOK ){        		*status = MM_MONDAIDATAEND;        	}            //ゲーム終了?        	else if( NextMondai()==MM_MONDAIDATAEND ){            	*status = MM_MONDAIDATAEND;            }        }    }	g_TypeIndex+=dwInc;	return ret;	}LPSTR GetStrokeString( UINT uID ){	if( uID == GSS_STATIC )		return (LPSTR)(g_Label);		return (LPSTR)(&(g_Type[g_TypeIndex]));}LPSTR GetSummanyString( UINT uSummanyID ){	return (LPSTR)(g_strSummany[uSummanyID]);}VOID CalcSummany( VOID ){	DWORD score = 0;	DWORD t,n;	WORD wDifficulty = GetGameOption()->wDifficulty;	INT i;	if( g_bGameClear ){ //レベル7と8をクリアしたらボーナス		if( wDifficulty == 8 )			score += 30000;		else if(  wDifficulty == 7 )			score += 10000;	}	//Num of mondai		wsprintf( g_strSummany[GSS_NUMOFMONDAI],"%ld",g_dwNumOfMondai );	 	 //Clear mondai	wsprintf( g_strSummany[GSS_CLEARMONDAI],"%ld",g_dwClearMondai );	score += g_dwClearMondai * wDifficulty * wDifficulty * 10;	//Mondai Average	if( g_dwNumOfMondai>0 ){		 	wsprintf( g_strSummany[GSS_MONDAIAVE],		 	"%3ld.%1ld",g_dwClearMondai*100/g_dwNumOfMondai,g_dwClearMondai*100%g_dwNumOfMondai );		 	//全てクリアーしたらボーナス		 	if( g_dwClearMondai == g_dwNumOfMondai )		 		score += 1000 * wDifficulty;	}	else{		 	lstrcpy( g_strSummany[GSS_MONDAIAVE],GetString(GS_ZERODOUBLE));	}			 		RemakeString( g_strSummany[GSS_MONDAIAVE],1 );	lstrcat( g_strSummany[GSS_MONDAIAVE],GetString(GS_PERCENT)); 			//Total stroke	wsprintf( g_strSummany[GSS_TYPETOTAL],"%ld",g_dwTypeTotal );		//Type miss total	wsprintf( g_strSummany[GSS_TYPEMISSTOTAL],"%ld",g_dwTypeMissTotal );		//Good Types Percentage	 n=g_dwTypeTotal-g_dwTypeMissTotal; 	 score += n * wDifficulty;   				                 if( g_dwTypeTotal > 0 ){         	wsprintf( g_strSummany[GSS_TYPEAVE],"%3ld.%1ld",n*100/g_dwTypeTotal,n*100%g_dwTypeTotal );	}	else{		lstrcpy( g_strSummany[GSS_TYPEAVE],GetString(GS_ZERODOUBLE));	}	RemakeString( g_strSummany[GSS_TYPEAVE],1 );	lstrcat( g_strSummany[GSS_TYPEAVE],GetString(GS_PERCENT)); 			 //Stroke speed	 t  = g_dwEndTime-g_dwStartTime;     t-=(g_dwClearMondai+g_dwMissMondai)*500;     n = g_dwTypeTotal-g_dwTypeMissTotal;     if( n>0 && t/n>0){          	t/=n;         	wsprintf( g_strSummany[GSS_TYPESPEED],"%2ld.%1ld%1ld",1000/t,1000%t,((1000%t)*10)/t );         	if( (1000/t) < 10 )         		score+=(1000/t)*n*wDifficulty;         	else         		score = 0;	//リピートを許さない	   	RemakeString( g_strSummany[GSS_TYPESPEED],2 );	   	lstrcat( g_strSummany[GSS_TYPESPEED],GetString(GS_SUMMANY_G_G ));	  }	   else{		lstrcpy( g_strSummany[GSS_TYPESPEED],GetString(GS_ZEROTRIPLE));		lstrcat( g_strSummany[GSS_TYPESPEED],GetString(GS_SUMMANY_G_G ));	  }	   	   //Total your score	   wsprintf( g_strSummany[GSS_LEVEL],"%ld Points",score );	   	   g_dwScore = score;	   for( i=0;i<10;i++ ){	   	score = GetGameOption()->sd[i].dwScore;	   	if( g_dwScore > score ){	   		g_iRank = i+1;	   		break;	   	}	   }	   	   //付随データの書き出し	   if( g_iRank > 0 ){	   	ShiftScoreData( g_iRank );	   	GetGameOption()->sd[g_iRank-1].wDifficulty=wDifficulty;	   	GetGameOption()->sd[g_iRank-1].bGameClear=g_bGameClear;	   	GetGameOption()->sd[g_iRank-1].dwNumOfStrings=g_dwNumOfMondai;	   	GetGameOption()->sd[g_iRank-1].dwClearStrings=g_dwClearMondai;	   	GetGameOption()->sd[g_iRank-1].dwTypeTotal=g_dwTypeTotal;	   	GetGameOption()->sd[g_iRank-1].dwTypeMissTotal=g_dwTypeMissTotal;	   	for( i=0;i<5;i++ ){	   		GetGameOption()->sd[g_iRank-1].cTypeSpeed[i]=g_strSummany[GSS_TYPESPEED][i];	   	}	   	GetGameOption()->sd[g_iRank-1].cTypeSpeed[i]='\0';	   		   	GetGameOption()->sd[g_iRank-1].dwScore=g_dwScore;	   	lstrcpy( GetGameOption()->sd[g_iRank-1].cName,"AAA" );	   }	}VOID RemakeString( LPSTR lpszIO,INT iNum ){	INT i;	INT s = lstrlen(lpszIO);	for( i=0;i<s;i++ ){	   		if( lpszIO[i]=='.' ){	   			if( i+iNum <s ){					lpszIO[i+iNum+1]='\0';   				   			}	   			break;	   			   		}	 }	}