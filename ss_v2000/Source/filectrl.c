#include "filectrl.h"static ERRCODE ReadTheFile( LPCTSTR lpszFile,LPVOID* lpData  );//ファイルパスからファイル名を取り出す//TRUE:成功 FALSE:失敗BOOL FilePathToFileName( LPTSTR lpszFile,LPCTSTR lpszPath,INT iMaxLength ){	CHAR szFile[MAX_PATH];	CHAR FAR* cp;	INT i,lim;	BOOL ret=FALSE;	if( iMaxLength <= 0 )		return ret;			ZeroMemory( lpszFile,iMaxLength ); //バッファ初期化		lstrcpyn( szFile,lpszPath,sizeof(szFile) );	lim = lstrlen( szFile );	if( lim <= 0 )		return ret;		 	cp = (CHAR FAR*)&szFile[lim-1]; //終端にセット	for( i=0;i<lim;i++ ){		if( (*cp) == 0x5C ){ //'\'			ret = TRUE; //OK			cp++;//単独ファイル名へポイント			break;		}		cp--; //前の文字へ	}	if( ret )		lstrcpyn( lpszFile,cp,iMaxLength ); //ファイル名セット			return ret;}ERRCODE ReadFileToMemory( LPCTSTR lpszFile,LPVOID* lpData  ){	ERRCODE err;	CHAR szFile[MAX_PATH];		err = ReadTheFile( lpszFile,lpData );	if( err == ERR_FILEACCESS ){		if( FilePathToFileName( szFile,lpszFile,sizeof(szFile) ) )			err = ReadTheFile( szFile,lpData );//カレントディレクトリにチャレンジ			}		return err;}ERRCODE ReadTheFile( LPCTSTR lpszFile,LPVOID* lpData  ){		HANDLE hFile;	DWORD dwBytesRead,s;	ERRCODE uErr;	LPVOID lpMem;		lpMem = NULL;	uErr = ERR_NOTHING;		//ファイルの読み込み	if ((hFile = CreateFile(lpszFile,			GENERIC_READ,			FILE_SHARE_READ,			NULL,			OPEN_EXISTING,			FILE_ATTRIBUTE_NORMAL,			(HANDLE)NULL)) != (HANDLE)-1){            	if(( s = GetFileSize( hFile,NULL ))!=0xFFFFFFFF){            		if( (lpMem = (LPVOID)GlobalAlloc(  GMEM_FIXED,s ))!=NULL){                       ReadFile(hFile,lpMem,s,&dwBytesRead, NULL);         			if (dwBytesRead != 0){					CloseHandle(hFile);            			}                            else{                                GlobalFree( lpMem );                                lpMem = NULL;                                uErr = ERR_FILEACCESS;                            }        		}                     else{                    	CloseHandle( hFile );                    	uErr = ERR_MEMORY;        		}        	    }		else{			uErr = ERR_FILEACCESS;		}  	}	else{		uErr = ERR_FILEACCESS;	}	*lpData=lpMem;	return uErr;	}