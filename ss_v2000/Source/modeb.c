#include "modeb.h"#include "drawctrl.h"#include "timectrl.h"#include "fade.h"#include "appdata.h"#include "dibctrl.h"extern HWND g_hWnd;static HFONT g_hFontOld; /* Work */static BOOL g_bIsWaiting;static BOOL g_bIsDelaying;static INT g_iCurRect = -1;static TEXTFADE g_tfA;static TEXTFADE g_tfB;static INT g_iSelection = -1;static INT MouseCheck( WORD x,WORD y );INT GetModeBSelection( VOID ){	return g_iSelection;}VOID StartModeB(  BOOL bErase  ){	RECT r;	CopyRect( &r,GetRectangle( GR_MODEB_GUIDE_A ) );	g_tfA.rgbOrg.rgbRed = 0xFF; 	g_tfA.rgbOrg.rgbGreen = 0xFF;	g_tfA.rgbOrg.rgbBlue = 0xFF;	g_tfB.rgbOrg.rgbRed = 0x00; 	g_tfB.rgbOrg.rgbGreen = 0xFF;	g_tfB.rgbOrg.rgbBlue = 0xFF;	BeginDIBFade( GetDIBFade() );	BeginTextFade( &g_tfA );	BeginTextFade( &g_tfB );	g_bIsWaiting = FALSE;	g_bIsDelaying = FALSE;	g_iCurRect = -1;	g_iSelection = -1;		SwitchScreen( SS_MODEB, bErase/* AllWays FALSE! */ );	SetCursorPos( r.left+(r.right-r.left)/2,r.top+(r.bottom-r.top)/2 );}	VOID CursorModeB( WORD x,WORD y ){	INT i;	RECT r;		if( !g_bIsWaiting )		return;		i = MouseCheck( x,y );		//状況に変化なし	if(  i == g_iCurRect )		return;			//マウスが離れた	if( g_iCurRect != -1 ){		CopyRect( &r,GetRectangle( GR_MODEB_GUIDE_A+g_iCurRect ));		InvalidateRect( g_hWnd,&r,FALSE );		g_iCurRect = -1;		return;	}		//マウスが入ってきた	if( i >= 0 ){		CopyRect( &r,GetRectangle( GR_MODEB_GUIDE_A+i ));		InvalidateRect( g_hWnd,&r,FALSE );		g_iCurRect = i;	}	}INT MouseCheck( WORD x,WORD y ){	POINT p;	INT i;		p.x = x;	p.y = y;		for( i=0;i<4;i++ ){		if( PtInRect( GetRectangle( GR_MODEB_GUIDE_A+i),p ) )			return i;	}		return (-1);	}VOID ClickModeB( WORD x,WORD y ){	INT i;	if( !g_bIsWaiting )		return;	i = MouseCheck( x,y );		if( i != -1 ){		g_iSelection = i;		g_bIsWaiting = FALSE;		ShowCursor( FALSE );		StartTimer( ST_MODEB );	}	}VOID KeyModeB( UINT key ){	POINT p;	if( key == VK_RETURN ){		GetCursorPos( &p );		ClickModeB( (WORD)p.x,(WORD)p.y );	}}BOOL ProcessModeB( VOID ){	FADESTATUS st;	POINT p;	if( g_bIsDelaying ){		EndTimer();		g_bIsDelaying = FALSE;		g_bIsWaiting = TRUE;		ShowCursor( TRUE  );		GetCursorPos( &p );		CursorModeB( p.x,p.y );		return TRUE;	}		st = FadeTextFade( &g_tfA );		st = FadeTextFade( &g_tfB );		st = FadeDIBFade( GetDIBFade() );			InvalidateRect( g_hWnd,GetRectangle( GR_MODEB ),FALSE );			if( st==FADE_INEND ){ //Let's Wait.			g_bIsDelaying = TRUE;			StartTimerEx( ST_MODEB,700 );			return TRUE;		}		else if( st == FADE_OUTEND ){			EndTimer();			return FALSE;		}			return TRUE;	}VOID DrawModeB( HDC hDC ){	INT i;	LPRECT r = GetRectangle( GR_MODEB );	DibBlt( hDC,r->left,r->top,GetDIBFade()->dwWidth,GetDIBFade()->dwHeight,				GetDIBFade()->hDIB,0,0,SRCCOPY );		SELECTFONT( GetFont(GF_MODEB_GUIDE) );		for( i=0;i<4;i++ ){		  if( g_iCurRect == i )		COLORTEXT( g_tfB.rgbNow.rgbRed,g_tfB.rgbNow.rgbGreen,g_tfB.rgbNow.rgbBlue );	  else	  	COLORTEXT( g_tfA.rgbNow.rgbRed,g_tfA.rgbNow.rgbGreen,g_tfA.rgbNow.rgbBlue );			DRAWTEXTLEFT( GetString( GS_MODEB_GUIDE_A+i ),GetRectangle(GR_MODEB_GUIDE_A+i) );		}		 RESTOREFONT();}