#include "drawctrl.h"#include "modec.h"#include "timectrl.h"#include "appdata.h"#include "fade.h"#include "mondai.h"extern HWND g_hWnd;static HFONT g_hFontOld; /* Work */static BOOL	g_bIsWaiting = FALSE;static BOOL	g_bIsDelaying = FALSE;static INT g_iCurRect = -1;static INT g_iCurNextPrev = -1;static INT g_iRects = 0;static INT g_iCurPage = 0;static INT g_iPages = 1;static INT g_iRectsLast = 0;static INT g_iRectsNow = 0;static INT g_iSelection = 0;static TEXTFADE g_tfA;static TEXTFADE g_tfB;static TEXTFADE g_tfC;static INT MouseCheck( WORD x,WORD y );static INT MouseCheckNextPrev( WORD x,WORD y );static VOID IncrementModeC( VOID );static VOID DecrementModeC( VOID );INT GetModeCSelection( VOID ){	return g_iSelection;}VOID StartModeC( BOOL bErase ){	RECT r;	CopyRect( &r,GetRectangle( GR_MODEC_B ) );	g_tfA.rgbOrg.rgbRed = 0xFF; 	g_tfA.rgbOrg.rgbGreen = 0xFF;	g_tfA.rgbOrg.rgbBlue = 0xFF;	g_tfB.rgbOrg.rgbRed = 0xFF; 	g_tfB.rgbOrg.rgbGreen = 0x00;	g_tfB.rgbOrg.rgbBlue = 0xFF;	g_tfC.rgbOrg.rgbRed = 0x00; 	g_tfC.rgbOrg.rgbGreen = 0xFF;	g_tfC.rgbOrg.rgbBlue = 0xFF;		g_iSelection = 0;		g_bIsWaiting = FALSE;	g_bIsDelaying = FALSE;	g_iCurRect = -1;	g_iCurNextPrev = -1;	g_iCurPage = 0;	g_iRectsLast = 0;		{ INT amari,onesize,okrects;	amari = GetRectangle( GR_MODEC_C )->top - r.bottom-(r.bottom-r.top);	onesize = (r.bottom-r.top)*2;	okrects = (amari/onesize+1)*2;		g_iRects = min( (GetSSTA()->dwNumOfSST)+1,okrects ); //+1 is All Junre		}	g_iPages = ((GetSSTA()->dwNumOfSST)+1)/g_iRects;	g_iRectsLast = ((GetSSTA()->dwNumOfSST)+1)%g_iRects;	if( g_iRectsLast )		g_iPages++;	else		g_iRectsLast = g_iRects;			g_iRectsNow = g_iRects;	BeginTextFade( &g_tfA );	BeginTextFade( &g_tfB );	BeginTextFade( &g_tfC );	SwitchScreen( SS_MODEC,bErase );		SetCursorPos( r.left+(r.right-r.left)/2,r.top+(r.bottom-r.top)/2 );}BOOL ProcessModeC( VOID ){	FADESTATUS st;	POINT p;	if( g_bIsDelaying ){		EndTimer();		g_bIsDelaying = FALSE;		g_bIsWaiting = TRUE;		ShowCursor( TRUE  );		GetCursorPos( &p );		CursorModeC( p.x,p.y );		return TRUE;	}		st = FadeTextFade( &g_tfA );		st = FadeTextFade( &g_tfB );		st = FadeTextFade( &g_tfC );		InvalidateRect( g_hWnd,GetRectangle( GR_MODEC ),FALSE );		if( st==FADE_INEND ){ //Let's Wait.			g_bIsDelaying = TRUE;			StartTimerEx( ST_MODEC,700 );			return TRUE;		}		else if( st == FADE_OUTEND ){			EndTimer();			return FALSE;		}			return TRUE;}VOID CursorModeC( WORD x,WORD y ){	INT i,iNextPrev,w,h;	RECT r;		if( !g_bIsWaiting )		return;		i = MouseCheck( x,y );	iNextPrev = MouseCheckNextPrev( x,y );		//状況に変化なし	if(  i == g_iCurRect && iNextPrev == g_iCurNextPrev)		return;			//マウスが離れた			if( g_iCurRect != -1 && i>=g_iRectsNow ){		CopyRect( &r,GetRectangle( GR_MODEC_B ));		w = r.right-r.left;		h = r.bottom-r.top;		OffsetRect( &r,(g_iCurRect%2)*w, (g_iCurRect/2)*(h*2) );		InvalidateRect( g_hWnd,&r,FALSE );		InvalidateRect( g_hWnd,GetRectangle( GR_MODEC_C ),TRUE );		g_iCurRect = -1;		return;	}		//マウスが離れた	if( g_iCurNextPrev != -1 && iNextPrev==-1 ){		if( g_iCurNextPrev == 0 )			InvalidateRect( g_hWnd,GetRectangle( GR_MODEC_PREV),FALSE );		else			InvalidateRect( g_hWnd,GetRectangle( GR_MODEC_NEXT),FALSE );			g_iCurNextPrev = -1;		return;	}	//マウスが入ってきた	if( i < g_iRectsNow ){			if( g_iCurRect != -1 ){ //ワープしてくる場合がある			CopyRect( &r,GetRectangle( GR_MODEC_B ));			w = r.right-r.left;			h = r.bottom-r.top;			OffsetRect( &r,(g_iCurRect%2)*w, (g_iCurRect/2)*(h*2) );			InvalidateRect( g_hWnd,&r,FALSE );		}			CopyRect( &r,GetRectangle( GR_MODEC_B ));		w = r.right-r.left;		h = r.bottom-r.top;		OffsetRect( &r,(i%2)*w, (i/2)*(h*2) );		InvalidateRect( g_hWnd,&r,FALSE );		InvalidateRect( g_hWnd,GetRectangle( GR_MODEC_C ),TRUE );		g_iCurRect = i;	}	//マウスが入ってきた	if( iNextPrev!=-1 ){			if( g_iCurNextPrev != -1 ){//ワープしてくる場合がある			if( g_iCurNextPrev == 0 )				InvalidateRect( g_hWnd,GetRectangle( GR_MODEC_PREV),FALSE );			else				InvalidateRect( g_hWnd,GetRectangle( GR_MODEC_NEXT),FALSE );		}			if( iNextPrev == 0 )			InvalidateRect( g_hWnd,GetRectangle( GR_MODEC_PREV),FALSE );		else			InvalidateRect( g_hWnd,GetRectangle( GR_MODEC_NEXT),FALSE );			g_iCurNextPrev = iNextPrev;	}}VOID ClickModeC( WORD x,WORD y ){	INT i,iNextPrev,id;	if( !g_bIsWaiting )		return;	i = MouseCheck( x,y );		if(  i == g_iCurRect ){		if( i==0 && g_iCurPage == 0 )			id = -1;		else			id = (g_iRects*g_iCurPage-1)+i;		//	id = i-1;		SetSSTId( id );				g_iSelection = 1;		g_bIsWaiting = FALSE;		ShowCursor( FALSE );		StartTimer( ST_MODEC );		return;	}		iNextPrev = MouseCheckNextPrev( x,y );		if( iNextPrev == 0 ){		if( g_iCurPage != 0 )			DecrementModeC();		else{			g_iSelection = 0;			g_bIsWaiting = FALSE;			ShowCursor( FALSE );			StartTimer( ST_MODEC );			return;		}	}	else if( iNextPrev == 1 )		IncrementModeC();		}VOID IncrementModeC( VOID ){	RECT r;	CopyRect( &r,GetRectangle( GR_MODEC ) );	r.top = GetRectangle( GR_MODEC_A )->bottom; //「Stroke Selection」は描かない	g_iCurPage++;	if( g_iCurPage +1 == g_iPages ){		g_iRectsNow = g_iRectsLast;	}	InvalidateRect( g_hWnd,&r,TRUE );}VOID DecrementModeC( VOID ){	RECT r;	CopyRect( &r,GetRectangle( GR_MODEC ) );	r.top = GetRectangle( GR_MODEC_A )->bottom; //「Stroke Selection」は描かない	if( g_iCurPage +1  == g_iPages ){		g_iRectsNow = g_iRects;	}	g_iCurPage--;		InvalidateRect( g_hWnd,&r,TRUE );}VOID KeyModeC( UINT key ){	POINT p;	if( key == VK_RETURN ){		GetCursorPos( &p );		ClickModeC( (WORD)p.x,(WORD)p.y );	}}INT MouseCheck( WORD x,WORD y ){	SIZE size;	HDC hDC;	INT w,h,i;	RECT r;	POINT p;		p.x = x;	p.y = y;		CopyRect( &r,GetRectangle( GR_MODEC_B ));		w = r.right-r.left;	h = r.bottom-r.top;	hDC = GetDC( g_hWnd );	SELECTFONT( GetFont(GF_MODEC_B) );		for( i=0;i<g_iRectsNow;i++ ){		if( i == 0 && g_iCurPage == 0 )			GetTextExtentPoint32( hDC,			GetString(GS_MODEC_B),lstrlen(GetString(GS_MODEC_B)),&size );		else			GetTextExtentPoint32( hDC,			GetSSTA()->lpSST[(g_iRects*g_iCurPage-1)+i].lpszTitle,			lstrlen(GetSSTA()->lpSST[(g_iRects*g_iCurPage-1)+i].lpszTitle),&size );				CopyRect( &r,GetRectangle( GR_MODEC_B ));		OffsetRect( &r,(i%2)*w, (i/2)*(h*2) );		if( w > size.cx ){			r.left+=(w-size.cx)/2;			r.right-=(w-size.cx)/2;		}			if( PtInRect( &r,p ) )			break;	}			RESTOREFONT();	ReleaseDC( g_hWnd,hDC );		return i;}INT MouseCheckNextPrev( WORD x,WORD y ){	SIZE size0,size1;	HDC hDC;	INT w,h;	RECT r;	POINT p;		p.x = x;	p.y = y;	hDC = GetDC( g_hWnd );	SELECTFONT( GetFont(GF_MODEC_D) );		if( g_iCurPage == 0 ){		GetTextExtentPoint32( hDC,			GetString(GS_MODEC_TITLE),lstrlen(GetString(GS_MODEC_TITLE)),&size0 );	}	else{		GetTextExtentPoint32( hDC,			GetString(GS_MODEC_PREV),lstrlen(GetString(GS_MODEC_PREV)),&size0 );	}		GetTextExtentPoint32( hDC,			GetString(GS_MODEC_NEXT),lstrlen(GetString(GS_MODEC_NEXT)),&size1 );		RESTOREFONT();	ReleaseDC( g_hWnd,hDC );		CopyRect( &r,GetRectangle( GR_MODEC_PREV ));	w = r.right-r.left;	h = r.bottom-r.top;	if( w > size0.cx ) //左詰め		r.right-=w-size0.cx;		if( PtInRect( &r,p ) )		return 0;		CopyRect( &r,GetRectangle( GR_MODEC_NEXT ));	w = r.right-r.left;	h = r.bottom-r.top;	if( w > size1.cx ) //右詰め		r.left+=w-size1.cx;		if( PtInRect( &r,p ) && g_iCurPage+1 < g_iPages )			return 1;		return (-1);	}VOID DrawModeC( HDC hDC ){	INT i;	RECT r;	//ラベル	 SELECTFONT( GetFont(GF_MODEC_A) );	 COLORTEXT( g_tfB.rgbNow.rgbRed,g_tfB.rgbNow.rgbGreen,g_tfB.rgbNow.rgbBlue );     	 DRAWTEXTCENTER( GetString( GS_MODEC_A ),GetRectangle(GR_MODEC_A) );	 RESTOREFONT();	 	  SELECTFONT( GetFont(GF_MODEC_D) );	 	  if( g_iCurNextPrev == 0 )	 	COLORTEXT( g_tfC.rgbNow.rgbRed,g_tfC.rgbNow.rgbGreen,g_tfC.rgbNow.rgbBlue );	  else	  	COLORTEXT( g_tfA.rgbNow.rgbRed,g_tfA.rgbNow.rgbGreen,g_tfA.rgbNow.rgbBlue );	  		  if( g_iCurPage == 0 )	  	     	 	DRAWTEXTLEFT( GetString( GS_MODEC_TITLE ),GetRectangle(GR_MODEC_PREV) );     	 else     	 	DRAWTEXTLEFT( GetString( GS_MODEC_PREV ),GetRectangle(GR_MODEC_PREV) );        	      	 if( g_iCurPage+1 < g_iPages ){     	  if( g_iCurNextPrev == 1 )	 	COLORTEXT( g_tfC.rgbNow.rgbRed,g_tfC.rgbNow.rgbGreen,g_tfC.rgbNow.rgbBlue );	  else	  	COLORTEXT( g_tfA.rgbNow.rgbRed,g_tfA.rgbNow.rgbGreen,g_tfA.rgbNow.rgbBlue );     	 DRAWTEXTRIGHT( GetString( GS_MODEC_NEXT ),GetRectangle(GR_MODEC_NEXT) );	 }	 	 RESTOREFONT();	 	 //タイトル	 SELECTFONT( GetFont(GF_MODEC_B) );	 for( i=0;i<g_iRectsNow;i++ ){	  	if( g_iCurRect == i )	 		COLORTEXT( g_tfC.rgbNow.rgbRed,g_tfC.rgbNow.rgbGreen,g_tfC.rgbNow.rgbBlue );	 	else	 	 	COLORTEXT( g_tfA.rgbNow.rgbRed,g_tfA.rgbNow.rgbGreen,g_tfA.rgbNow.rgbBlue );	 	 	CopyRect( &r,GetRectangle( GR_MODEC_B ));		OffsetRect( &r,(i%2)*(r.right-r.left), (i/2)*((r.bottom-r.top)*2) );	 		 	if( i==0 && g_iCurPage == 0 )	 		DRAWTEXTCENTER( GetString(GS_MODEC_B),GetRectangle(GR_MODEC_B) );	 	else	 		DRAWTEXTCENTER( GetSSTA()->lpSST[(g_iRects*g_iCurPage-1)+i].lpszTitle,&r );	 		 }/*	  if( g_iCurRect == 0 )	 	COLORTEXT( g_tfC.rgbNow.rgbRed,g_tfC.rgbNow.rgbGreen,g_tfC.rgbNow.rgbBlue );	 else	 	 COLORTEXT( g_tfA.rgbNow.rgbRed,g_tfA.rgbNow.rgbGreen,g_tfA.rgbNow.rgbBlue );	 DRAWTEXTCENTER( GetString(GS_MODEC_B),GetRectangle(GR_MODEC_B) );*/	 	 	 RESTOREFONT();	 	 //説明	 if( g_iCurRect != -1 ){	 	SELECTFONT( GetFont(GF_MODEC_C) );	 	COLORTEXT( g_tfC.rgbNow.rgbRed,g_tfC.rgbNow.rgbGreen,g_tfC.rgbNow.rgbBlue );     	 	if( g_iCurRect == 0  && g_iCurPage == 0 )     	 		DRAWTEXTCENTER( GetString( GS_MODEC_C),GetRectangle(GR_MODEC_C) );	 	else	 		DRAWTEXTCENTER( GetSSTA()->lpSST[(g_iRects*g_iCurPage-1)+g_iCurRect].lpszDesc,     	 			GetRectangle(GR_MODEC_C) );		 	RESTOREFONT();	 }	}